---
output: 
    html_document:
      fig_caption: true
      css: custom_styles.css
      includes: 
        in_header: "header_manual.html" 
        after_body: "footer.html"
params:
  network: NETN
  Park: SARA
  state: NY
  year: 2019
  bcr: 13
  BCRName: Lower Great Lakes/St.Lawrence Plain
  BBSRegion: S13
  minYear: 2006
  maxYear: 2019
---
      
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# load in packages
library(magrittr)
library(devtools)
library(tidyverse)
library(NCRNbirds)
library(leaflet)
library(cowplot)
library(readxl)
library(lubridate)
library(plotly)
library(knitr)
library(kableExtra)
library(formattable)
library(RColorBrewer)
library(sf)
library(sp)
library(tmap)
library(spsurvey)



# load in network monitoring data and look-up tables

BirdData <- importNETNbirds("./Data/NETN") # needs to be fixed if multi-network
tlu_GuildRatings <- read_excel("./Data/tlu_GuildRatings.xlsx")
guild_tlu<-getGuilds(BirdData) %>% filter( BCI_Type == "Cent_Appal")%>% rename(Species_Guild = AOU_Code)
ParkList<-NCRNbirds::getParkNames(BirdData, name.class="code")

PIFSppByBCR<- read.csv("./Data/PIF_Species_BCR.csv") %>% # import Partners in Flight designations per BCR
  filter(BCR %in% params$bcr)

# create vector of forested points for queries excluding grassland sites 

forest.sites<-getVisits(BirdData[ParkList == params$Park], site="Forest") %>% select(Point_Name) %>% distinct() %>% pull()

#import datasets from Doser et al. 2020 trend estimates per species

#The file "spMeanTrends.csv" contains the data used to generate the trends in abundance for each species across the study years. It contains the annual estimates of species abundance after accounting for imperfect detection and effects of forest covariates. 

spMeanTrends <- read.csv("./Data/spMeanTrends.csv") %>% 
  pivot_longer(cols= 3:11, names_to = "park") %>% 
  add_column(variable = "Trend Estimate") %>% rename(Year = years, AOU_Code= species) %>% 
  dplyr::filter(park == params$Park)

#The file "spMeanYearEffect.csv" contains the trend estimate for abundance for each species at each park. It contains the mean, lowCI and hiCI coefficient estimate for the year effect after accounting for imperfect detection and effects of forest covariates. 

spMeanYearEffect <- read.csv("./Data/spMeanYearEffect.csv") %>% 
   pivot_longer(cols= 3:11, names_to = "park", values_to ="value") %>% 
  pivot_wider(id_cols=  c(park, species), names_from = "type", values_from= "value" ) %>% 
  rename(AOU_Code= species) %>% 
  dplyr::filter(park == params$Park)

# Read in estimated richness values from Doser et al. 2021 

ParkCommAnnual <- read.csv("./Data/park-rich-bci-by-year.csv")


# derive raw relative abundance from NETN monitoring to add on modeled estimates

sp_detects<- SumRelAbund(BirdData[ParkList == params$Park], band = 1:2, max= T) %>% # raw detection data created from SumRelAbund
  add_column(variable = "Field Observation", Admin_Unit_Code = params$Park) %>% select(park= Admin_Unit_Code, Year,  AOU_Code, value= RelAbund, variable) %>% 
  bind_rows(spMeanTrends)


# load in USGS BBS recent survey and analysis results (https://www.sciencebase.gov/catalog/item/5f1836a482cef313ed843104)

#Sauer, J.R., Link, W.A., and Hines, J.E., 2020, The North American Breeding Bird Survey, Analysis Results 1966 - 2019: U.S. Geological Survey data release, https://doi.org/10.5066/P96A7675.

BBS_trends <- read_excel("BBS trends/BBS_trends.xlsx", sheet = "trend")

# load and setup in SARA Veg map to denote forest vs field habitats (and corresponding routes)

# Read in shapefiles from spatial data folder
sara_bound<- st_read('./data/spatial/SARA_boundary_4269.shp') 
sara_veg <- st_read('./data/spatial/SARA_Veg.shp') 

# Check that the projections match; fix the one that doesn't match
st_crs(sara_bound) == st_crs(sara_veg) # FALSE- projections don't match.
# sara_bound1 needs to be reprojected to UTM Zone 18N NAD83. 
sara_bound <- st_transform(sara_bound, crs = 26918)
st_crs(sara_bound) == st_crs(sara_veg) # TRUE

# Intersect boundary and veg to be same extend
sara_veg <- st_intersection(sara_veg, sara_bound)
plot(sara_veg[1])

# Simplify vegetation types for easier plotting
table(sara_veg$ANDERSONII)

dev <- c('1. Urban or Built-up Land', '11. Residential', 
         '12. Commercial and Services', '13. Industrial',
         '14. Transportation, Communications, and Utilities', 
         '17. Other Urban or Built-up Land')
crop <- c('21. Cropland and Pasture', 
          '22. Orchards, Groves, Vineyards, and Nurseries', 
          '31. Herbaceous Rangeland')
shrubland <- c('32. Shrub and Brush Rangeland')
forest_up <- c('41. Deciduous Forest Land', '42. Evergreen Forest Land', 
               '43. Mixed Forest Land')
forest_wet <- c('61. Forested Wetland')
open_wet <- c('62. Nonforested wetland', '62. Nonforested Wetland')
water <- c('5. Water', '51. Streams and Canals', '53. Reservoirs')
unk <- 'Unclassified'

# Create 2 fields in the veg attribute table: simp_veg, and fills
sara_veg <- sara_veg %>% 
  dplyr::mutate(simp_veg = case_when(ANDERSONII %in% dev ~ 'Developed',
                              ANDERSONII %in% crop ~ 'Open field',
                              ANDERSONII %in% shrubland ~ 'Forest',
                              ANDERSONII %in% forest_up ~ 'Forest',
                              ANDERSONII %in% forest_wet ~ 'Forest',
                              ANDERSONII %in% open_wet ~ 'Open wetland',
                              ANDERSONII %in% water ~ 'Open water',
                              ANDERSONII %in% unk ~ 'Unclassified',
                              TRUE ~ 'Unknown'),
         fill_col = case_when(simp_veg == 'Developed' ~ '#D8D8D8',
                              simp_veg == 'Open field' ~ '#f5f0b0',
                              simp_veg == 'Shrublands' ~ '#F29839',
                              simp_veg == 'Powerline ROW' ~ '#F9421D',
                              simp_veg == 'Forest' ~ '#55785e',
                              simp_veg == 'Open wetland' ~ '#c497d4',
                              simp_veg == 'Open water' ~ '#AFD0F2',
                              simp_veg == 'Unclassified' ~ '#ffffff'))
# Creating list of simp_veg types and their fill colors for easier legend
 

sara_veg <- st_transform(sara_veg, crs = 4326) %>% filter(simp_veg %in% "Forest" | simp_veg %in% "Open field") %>% select(geometry, simp_veg, fill_col)

sara_veg_union<- sara_veg %>% 
  group_by(simp_veg, fill_col) %>% 
  summarize(geometry = st_combine(geometry)) 

mapCols<-colorFactor(c('#55785e','#f5f0b0'), domain = sara_veg_union$simp_veg)# set map colors for habitat types

```
<img src="NETN_Birdlogo_100.jpg" alt="landbird logo" style="height:100px;width:100.8px;float:right;padding:0;margin:10px -15px 0 0;">

`r getParkNames(BirdData[ParkList == params$Park], name.class = "long")`{.tabset .tabset-fade .tabset-pills}
------------------------------------
### Overview
<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r Effmap, echo = FALSE,  fig.height=5.75, fig.width= 5.75, fig.align = 'left', warning= FALSE, comment=FALSE, message=FALSE,}
NCRNbirds::mapEffort(BirdData[ParkList == params$Park],  palette = "viridis", title = paste0("Total surveys since ",params$minYear)) %>% addPolygons(data= sara_veg_union, label = sara_veg_union$simp_veg, weight = 0, smoothFactor = 0.5,opacity = 1.0, fillOpacity = 0.5, fillColor = ~mapCols(simp_veg), group= "Habitat Type") %>% addLegend(data= sara_veg_union, "bottomright", pal = mapCols, values = ~simp_veg,
    title = "Habitat Type",opacity = .5) %>% addLayersControl(overlayGroups = "Habitat Type", options = layersControlOptions(collapsed = FALSE)) %>% hideGroup("Habitat Type")

```
<p class='capwrap'>
Map of monitoring effort (no. surveys) at `r params$Park`'s 34 permanent forest and 25 grassland/open field sites between `r params$minYear` and `r params$maxYear`. You can click on the site to display its unique site identifier and the total number of species detected since `r params$minYear` when the Habitat Type layer (derived from Edinger et al. 2014) is not selected. </p>
</div>

<h3> Long-term bird monitoring program </h3>

<p> The Northeast Temperate Network's (NETN) breeding bird monitoring program has been implemented since 2006 in partnership with the <a href="https://vtecostudies.org/">Vermont Center of Ecostudies</a> and many volunteer birders. The program was established to determine status and trends in species diversity and the abundance of breeding landbirds in the park. </p>

Bird monitoring at `r params$Park` includes a combination of sites located in areas that are primarily forested (34) or within open field, grassland (25) habitats. Given the proximity of the sites to one another, many species are detected at sites located in both habitats. For instance, of the `r NCRNbirds::birdRichness(BirdData[ParkList == params$Park])` species detected, only 13 species have been detected in the grassland/open-field sites while 22 are unique to the forested sites. American Robin, Common Yellowthroat, and Black-capped Chickadee are examples of species found commonly at sites within both habitats whereas Bobolink, Eastern Meadowlark, Red-winged Blackbird, and Savannah Sparrow were found primarily in open habitats. For this reason some of the summary analyses presented in this report include data from forested and grassland/open field sites while some analyses such as the Bird Community Index and network-level trend analysis were restricted to monitoring data for species that breed within forested habitats. The Bird Community Index was developed strictly for measuring the health of the forest bird community and the trend analysis utilized NETN's forest vegetation monitoring data to evaluate effects of forest structure on the bird community. We lack similar vegetation data near our grassland monitoring sites and an analysis specific to the grassland birds is forthcoming.  

<p>This report summarizes monitoring results between `r params$minYear` and `r params$maxYear` in `r getParkNames(BirdData[ParkList == params$Park], name.class = "long")` (`r params$Park`) for the following topics:</p>
<ul>
 <li> <b>Bird Diversity:</b> A summary of the number of species detected since `r params$minYear` across all monitoring sites located in grassland/open field and forested habitats.</li> 
 <li> <b>Bird Community Index:</b> A summary of the condition of the park's forest bird community.</li> 
 <li> <b>Species Trends:</b> A summary of bird abundance over time for the most commonly detected forest-breeding species . </li> 
 <li> <b>Conclusions</b>: A summary of bird monitoring results in the context of park forest health. </li>
 <li> <b>Supporting Resources:</b> List of references and associated documentation for the bird monitoring program.</li> 
 </ul>

<br>
<h3>Methods</h3>

<p> The analyses in this report are based on repeated visits to  permanent monitoring sites shown in the map to the right. Each point is typically visited once a year but occasionally twice during the peak breading season from late spring to mid summer. At each visit all birds heard or seen during a 10-minute period are recorded. Additionally, the observers indicate an approximate distance to the bird. For detailed information on the methods and analysis, please consult the Supporting Resources. </p>

<p> If you have questions about this program, report, or would like to acquire data or speak about bird monitoring in your park please contact NETN staff  <a href="mailto:ed_sharron@nps.gov"> Ed Sharron (Bird Volunteer Coordinator)</a>,  <a href="mailto:adam_kozlowksi@nps.gov"> Adam Kozlowski (Data Manager)</a>, or <a href="mailto: aaron_weed@nps.gov"> Aaron Weed (Program Manager)</a>.</p>

### Bird Diversity {.tabset }

<p>  The number of detected species (or species richness) is a key metric from our monitoring because it provides a straight-forward indication of the bird diversity using `r params$Park` as breeding habitat during the summer. The number of species may change over time due to many factors affecting the local area surrounding the park (e.g., weather, habitat type, vegetation composition) or factors affecting bird populations at greater geographic scales, such as trends in regional forest structure (Holmes and Sherry 2001), land use, and wintering habitat survival. <b> The following summaries were derived from sites within the park's forest and open, grassland sites </b>.</p> 


#### No. of Species Over Time

<p> <b>There are three main take-home messages related to bird diversity from our monitoring thus far: </b> </p> 
<ul>
<li> At `r params$Park`, a total of `r NCRNbirds::birdRichness(BirdData[ParkList == params$Park])` bird species has been detected between `r params$minYear` to `r params$maxYear` with an average of `r NCRNbirds::birdRichness(BirdData[ParkList == params$Park], byYear = TRUE) %>% dplyr::pull(Richness) %>% mean() %>% round(0)` species detected per year <b> across forested and grassland sites </b> (Figure 1, blue). It is likely that not all species encountered during monitoring breed within the park but the number breeding is close to the observed average species richness. Total species richness at our `r params$Park` sites ranks as #1 among the 10 NETN parks included in the analysis (Figure 2) but it is important to note that we monitor grassland/open field habitats at MIMA and SARA in addition to our forested sites where in most parks we only monitor forests. </li>
<p>
<li> Although slightly increasing over time, the average number of species detected at our sites has remained <b> unchanged </b> (statistically speaking) between `r params$minYear` to `r params$maxYear` in `r params$Park` (Figures 1 and 3). The trend model (Figure 1, green) estimated fewer species in a couple of years but overall the species diversity detected during monitoring is very similar from year to year and most field observations fall within the confidence intervals (gray shading). </li> 
<p>
<li> While the number of bird species in `r params$Park` has not changed over time, it is one of 4 `r params$network` parks showing a slight (but non-significant) increase in average species richness over time (Figure 3). </li>
</ul>

<p class='caption'>
```{r richness, echo = TRUE, echo=FALSE, fig.height=4, fig.width= 10, fig.align = 'left', fig.cap= "Figure 1. Observed (blue) and estimated (green) species richness over time. Data summaries exclude species not suspected to be breeding in the forest (e.g., flyovers, grassland obligate breeders). The number of species estimated (green) is based on the study by Doser et al. (2021), which accounts for imperfect detection and the effects of forest structure. Note that this plot is not showing the total number of bird species in the park and other bird species may be present that were not detected during monitoring."}

plotdata<- dplyr::filter(ParkCommAnnual, park == params$Park) %>% select(Year= year, `Estimated Richness` = median.rich, low = low.95.rich, hi = high.95.rich) %>% 
  left_join(., NCRNbirds::birdRichness(BirdData[ParkList == params$Park], band= 1:2, byYear = TRUE), by = "Year") %>% dplyr::rename(`Observed Richness` = Richness) 

colors<- c("Field Observation" = "#2171b5","Estimated (95% C.I.)"= "dark green")
 
GraphOut<-ggplot(data=plotdata, aes(x = Year))+expand_limits(y=0)+
      geom_ribbon(data= plotdata, aes(ymin= low, ymax= hi), fill= "grey70", outline.type = "both")+
      geom_point(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"),  size=2)+geom_line(aes(y= `Estimated Richness`, color = "Estimated (95% C.I.)"))+
      geom_point(aes(y= `Observed Richness`, color= "Field Observation"), size=2) + geom_line(aes(y= `Observed Richness`, color= "Field Observation"))+
      theme_classic()+  
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 12))+
      scale_color_manual(values = colors)+
      scale_x_continuous(breaks = seq(2006, 2019,2))+
      labs(y=" Number of Species" ,x= "", color = "")+theme(legend.position = c(0.8,0.2))+ theme(legend.text = element_text(size = 14))

ggplotly(GraphOut)

```
</p>

```{r, richPark, echo=F, fig.align = 'left',fig.cap= "Figure 2. Total number of species detected per park during all surveys since monitoring began including detections at grassland sites in MIMA and SARA."}

# rank order for species richness among parks (includes grassland sites)
plotdata<-NCRNbirds::birdRichness(BirdData, byPark =T) %>% arrange(desc(Richness)) %>% mutate(order= row_number()) %>% mutate(Admin_Unit_Code = fct_reorder(Admin_Unit_Code, order)) %>% mutate(highlight= if_else(Admin_Unit_Code == params$Park,"yes","no")) %>% filter(Admin_Unit_Code != "SAIR" & Admin_Unit_Code != "ROVA")

GraphOut<-ggplot(data=plotdata, aes(x=reorder(Admin_Unit_Code,Richness), y= Richness, fill= highlight))+geom_bar(stat = "identity", width=0.75)+
 scale_fill_manual(values =c("#2171b5","forestgreen"), guide=FALSE)+
  coord_flip()+
  theme_classic()+  
      theme(axis.title.x =element_text(size = 14, face ="bold"))+
      theme(axis.text.y = element_text(color="black", size = 12))+
      theme(axis.text.x = element_text(color="black", size = 12))+
      labs(x="", y="Total Number of Species Detected")+
    geom_text(
    aes(label = Richness),
    position = position_dodge(0.9),hjust=-.10)+
  theme(legend.position = "none") 


GraphOut
```

```{r, richTrend, echo=F, fig.cap='Figure 3. Trends in estimated park-level species richness from 2006-2019. Points are the average species richness across all sites, gray regions denote the 95% credible intervals (measure of uncertainty). Inset text is the median (95% credible interval) linear trend estimating change per year in species richness (Doser et al. 2021). Note that observations at ELRO, HOFR, and VAMA were combined under ROVA for the analysis and the model predicts species richness in years that were not sampled (e.g., SAGA: 2007).', fig.align='left'}
knitr::include_graphics("Fig4.jpg")
```


#### No. of Species Across Monitoring Sites

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r richmap, echo = FALSE,  fig.height=6, fig.width= 6, fig.align = 'left', warning= FALSE, comment=FALSE, message=FALSE}
mapRichness(BirdData[ParkList == params$Park], title = "No. of species", palette = "viridis", band = 1:2) %>% addPolygons(data= sara_veg_union, label = sara_veg_union$simp_veg, weight = 0, smoothFactor = 0.5,opacity = 1.0, fillOpacity = 0.5, fillColor = ~mapCols(simp_veg), group= "Habitat Type") %>% addLegend(data= sara_veg_union, "bottomright", pal = mapCols, values = ~simp_veg,
    title = "Habitat Type",opacity = .5) %>% addLayersControl(overlayGroups = "Habitat Type", options = layersControlOptions(collapsed = FALSE)
  ) %>% hideGroup("Habitat Type")
```
<p class='capwrap'>
Map of cumulative bird species richness detected at `r params$Park`'s permanent monitoring sites between `r params$minYear` and `r params$maxYear`. You can click on the site to display its unique site identifier and total number of species detected since `r params$minYear` when the Habitat Type layer (derived from Edinger et al. 2014) is not selected.</p>
</div>

<p> While no formal analysis has been completed, this map shows that cumulative species richness varies across the monitoring sites with a slight increase in species diversity detected in the western portion of the monitoring area (Route 26: Burgoyne's Headquarter). Note that these differences among sites may be due to habitat quality but maybe also be due to differences in the number of surveys at our sites since monitoring began. </p>

<p> (If for some reason the map is not loading correctly, please right-click on the map and select "Reload") </p>

### Bird Community Index {.tabset }

<p> The Bird Community Index (BCI; O'Connell et al. 1998, 2000) is an index designed to indicate the conservation status (or “health”) of the bird community in <b> forested areas </b> such as those in `r params$network` parks. It was developed for conservation of forest birds common within the Central Appalachian region but our analyses indicate that it is also applicable to and helpful for characterizing breeding birds in `r params$network` parks because of the similarity of species. To calculate the BCI, the list of bird species from each site is considered separately. If a site has many bird species that are dependent upon intact forest areas during breeding (&quot;forest obligates&quot;) the site gets a high score, whereas birds that live in a variety of areas (&quot;generalists&quot;) give a site a low score.</p>

<p> Many factors are used to assess the degree to which a bird species is a generalist or a forest obligate. These
include: </p>
<p>
<ul>
 <li>What habitat does the species prefer?</li>
 <li>Is the species restricted to the interior of forests?</li>
 <li>Where does the species nest (trees, shrubs, ground, etc)?</li>
 <li>What does the species eat (insects in bark, insect on the ground, omnivore, etc)? </li>
 <li>Is the species a predator or parasite of other bird's nests?</li>
 <li>Is the species exotic?</li>
 <li>Is the species a park resident year-round or does it migrate?</li>
 <li>How many broods does the species raise per year?</li>
</ul>
</p>
<p>Based on these assessments each survey site is assigned a BCI score. The scores are then averaged for the entire park in each year.
This average score is used to categorize the bird community of the park as either Low, Medium, High, or Highest Integrity. </p>

#### BCI Over Time

Figure 4 shows that the BCI rating at `r params$Park`'s 34 <b> forested sites </b> has remained relatively unchanged since `r params$minYear` and is of "Medium Integrity" compared to other bird communities within the Central Appalachian region. A score of Medium Integrity at `r params$Park` is not surprising given the surrounding land-use and forest health history and is due to the presence of generalist species, exotic species (e.g., European Starling, House Sparrow), brood parasites (e.g., Brown-headed Cowbird), and a relatively small diversity of interior forest obligates (but many are present). 

<div style="float:right;position:relative;top:10px;padding:1px 1px 1px 1px;margin:0px 5px 10px 5px">
```{r BCI, echo=FALSE, fig.height=4, fig.width= 8, fig.align = 'left',fig.cap= "Figure 4. Annual Bird Community Index values averaged across the park forest. Data summaries exclude species not suspected to be breeding in the forest (e.g., flyovers). The annual BCI value shown is the average (+/-95% C.I.) BCI rating across all monitoring sites. The horizontal axis indicates the year, with the number of points monitored by visit in parenthesis.", message=FALSE}
NCRNbirds::BCIPlot(BirdData[ParkList == params$Park], type= "Cent_Appal",  plot_title = "", band = 1:2, caption = FALSE, points = forest.sites)

```

</div>

#### BCI Across Monitoring Sites
Bird Community Index ratings for permanent <b>forested </b> monitoring sites from `r params$minYear` to `r params$maxYear` are shown below across `r params$Park`. BCI scores are mostly rated as Medium Integrity across the park with a few sites rated as Low Integrity (5 of 23). 

```{r figcap, echo=F, results = 'hide'}
map_figcap <- paste0("Map of Bird Community Index ratings for permanent forest monitoring sites in ", params$Park, " from ",  params$minYear, " to ", params$maxYear, ". Data summaries exclude species not suspected to be breeding in the forest (e.g., flyovers, grass obligate breeders). Clicking on the site displays the unique site name and the BCI rating.")
```

```{r BCIrichmap, echo = TRUE, echo=FALSE, fig.height=6, fig.width= 10, fig.align = 'left', message=FALSE, fig.cap = map_figcap}

mapBCI(BirdData[ParkList == params$Park], band =1:2, type= "Cent_Appal", years = params$minYear:params$maxYear, maptype = "basic",  points = forest.sites)
```


#### BCI Compared to Other NETN Parks

As of `r params$maxYear`, `r params$Park` has the lowest BCI rating in `r params$network` (Figure 5). An analysis concluded that trends in overall bird abundance seem to be declining the fastest in parks with the highest BCI rating (Doser et al. 2021) (Figure 6).   

```{r, BCIPark, echo=F, fig.height=4, fig.width= 8, fig.align = 'left', fig.cap= "Figure 5. Average BCI score per park since monitoring began", cache= TRUE}

BCIPark<- map(BirdData, ~BCI(.x))# calc BCI per park

parkdata<-BCIPark %>% map("BCI")%>% map_dbl(mean) %>% round(1) # calc mean BCI

plotdata<- data.frame(Admin_Unit_Code= ParkList, BCI=parkdata, BCI_Category=NA) %>% filter(Admin_Unit_Code != "SAIR")

plotdata<- plotdata  %>% arrange() %>% 
  mutate(order= row_number()) %>% mutate(Admin_Unit_Code = fct_reorder(Admin_Unit_Code, order)) %>% mutate(shape= if_else(Admin_Unit_Code == params$Park,"8","1")) %>% 
  mutate(BCI_Category=case_when( BCI <40.1 ~"Low Integrity",
        BCI>=40.1 & BCI<52.1 ~ "Medium Integrity",
        BCI>=52.1 & BCI < 60.1 ~ "High Integrity",
        BCI>=60.1 ~ "Highest Integrity" ), 
        BCI_Category=factor(BCI_Category, levels=c("Low Integrity","Medium Integrity",
        "High Integrity","Highest Integrity")))

BCIColors<-brewer.pal(4,"BuGn") 
   
names(BCIColors)<-c("Low Integrity", "Medium Integrity", "High Integrity", "Highest Integrity")

GraphOut<-ggplot(data=plotdata, aes(x=reorder(Admin_Unit_Code,BCI), y= BCI, color=BCI_Category))+
  annotate("rect", ymin=0,  ymax=40, xmin=-Inf, xmax=Inf, fill=BCIColors[1]) +
      annotate("rect", ymin=40, ymax=52, xmin=-Inf, xmax=Inf, fill=BCIColors[2]) +
      annotate("rect", ymin=52, ymax=60, xmin=-Inf, xmax=Inf, fill=BCIColors[3]) +
      annotate("rect", ymin=60, ymax=80, xmin=-Inf, xmax=Inf, fill=BCIColors[4]) +
  geom_pointrange(aes(ymin=0, ymax=0),fatten=4, size=1) +
  geom_point(size = 4, color= "black")+
   scale_color_manual(values=BCIColors, drop=FALSE) +
  guides(color=guide_legend(reverse=T, title ="BCI Category"))+
   theme(axis.title.x =element_text(size = 14, face ="bold"))+
      theme(axis.text.y = element_text(color="black", size = 12))+
      theme(axis.text.x = element_text(color="black", size = 14))+
      labs(x="", y="Bird Community Index")+
   theme_classic()

GraphOut
```
<p>

```{r, BCITrend, echo=F, fig.align = 'left', fig.cap="Figure 6. Relationship between the estimated trend in bird abundance over time for each park and the average BCI at each park (Doser et al. 2021). The y-axis is the estimated change in bird abundance (log-scale) per site every 4 years. Values below 0 indicate declining bird abundance (see Figure 9 under Species Trends section for more information). Vertical error bars represent the 95% CI for the trend and horizontal error bars represent the 95% CI for the BCI. Inset text is the estimated Pearson’s correlation coefficient (with 95% CI). Note that observations at ELRO, HOFR, and VAMA were combined under ROVA for the analysis."}
knitr::include_graphics("trendBCIRelationship.jpg")
```

### Species Trends {.tabset}

Monitoring the status and trends of breeding birds in `r params$network` parks is a primary objective for the program. We assess population status and trends based on the abundance of each species detected over time. The tabs below illustrate the status and trends of the most common species encountered in `r params$Park`, <b> however, grassland obligate breeders (e.g., Eastern Meadowlark, Bobolink) and a few others primarily detected in grassland/open field sites (e.g. American Kestrel, Tree Swallow) were <u> excluded from the trend analysis </u> since they do not breed in forested habitats.</b> We have provided estimates of their relative abundance and an analysis specific to the grassland obligate breeders is forthcoming. Trends were calculated for some species commonly detected in the grassland/open field sites (Red winged-black bird, Field Sparrow) that are closely associated with forested habitats such as forest edge, scrub, wetlands, and open woodlands, were detected at other park forests, and we could evaluate their abundance in the context of the surrounding forest habitat. Please see Doser et al. (2020) for further details of why certain species were excluded from the trend analysis.

#### Relative Abundance

<p> Relative abundance, expressed as the average of the maximum number of birds detected per site per year from `r params$minYear` to `r params$maxYear`, provides an indication of how often a particular species is observed during monitoring and reflects its population status in the park. Figure 7 shows that the most common species detected at `r params$Park` are a mix of species common to our region and of conservation importance. </p>

<p> Bird Conservation Regions (BCRs) are ecologically distinct regions in North America with similar bird communities <a href="https://www.nabci-us.org/"> (www.nabci-us.org)</a>. `r params$Park` is located within the `r params$BCRName` BCR. Within this region, species of regional conservation importance have been designated based on rankings by Partners in Flight (Panjabi et al. 2020). 

<strong> Twenty species of regional conservation concern within the `r params$BCRName` BCR have been detected at `r params$Park`</strong>, including American Kestrel, Barn Swallow, Black-billed Cuckoo, Belted Kingfisher, Bobolink, Brown Thrasher, Blue-winged Warbler, Eastern Kingbird, Eastern Meadowlark, Eastern Wood-Pewee, Field Sparrow, Golden-winged Warbler, Least Flycatcher, Northern Bobwhite, Northern Flicker, Northern Harrier, Rose-breasted Grosbeak, Veery, Vesper Sparrow, and Wood Thrush. Of these, 5 are among the 20 most abundant species detected (Figure 7)! </p>

```{r BCR birds, results='hide', echo= FALSE}
# generate species detected in park that are on the PIF checklist (does not print)

PIFSpecies<- getChecklist(BirdData[ParkList == params$Park], out.style = "AOU", band=1:2) %>% 
  as_tibble() %>% rename(AOU_Code = 1) %>% 
  left_join(.,PIFSppByBCR, by="AOU_Code") %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"*","")) %>% 
  filter(PIF == "*") 
```


```{r top20,echo=FALSE,results='hide',fig.keep='all', cache= FALSE,  fig.height=6, fig.width= 8, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA}

aou<-SumRelAbund(BirdData[ParkList == params$Park], max=T, sort=TRUE, abund = 20, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(BirdData[ParkList == params$Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% as_tibble() %>% rename(common = 1, AOU_Code =2)
      
plotdata<-SumRelAbund(BirdData[ParkList == params$Park], max=T, AOU = aou, band = 1:2, CalcByYear =FALSE ) %>% 
  group_by(AOU_Code) %>% 
  summarise(mean = round(mean(RelAbund,na.rm=T),2), se = sd(RelAbund)/sqrt(n()), n= n()) %>% 
  left_join(spp,., by = "AOU_Code") %>% 
  left_join(.,PIFSppByBCR, by= "AOU_Code") %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"*","")) %>% 
  mutate(common2 = if_else(is.na(PIF), common, paste(PIF,"",common))) %>% 
  mutate(common2 = fct_reorder(common2, mean))
  
BarChart<-ggplot(data= plotdata, aes(x=reorder(common2,mean), y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
#geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
coord_flip()+
geom_text(aes(label = sprintf("%0.2f", round(mean, digits = 2))), hjust = -0.15, color = "black", size = 4)+
scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") + labs(title = paste0("Abundance of the 20 most commonly detected species in ", params$Park))+
ylab("Average number of birds detected per site per year")+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))

BarChart
```
<p class='caption'>
Figure 7. Relative abundance of the 20 most commonly detected species at `r params$Park`. Data summaries exclude species not suspected to be breeding in the park (e.g., flyovers) and include species detected in forested and grassland/open field sites. Relative abundance is calculated as the maximum number of detections per species among visits to all sites in a year divided by the total number of sites monitored from `r params$minYear` to `r params$maxYear`. Asterisks next to a species name denote species designated by Partners in Flight to be of conservation importance within the `r params$BCRName` BCR (Panjabi et al. 2020).</p>

#### Trends Over Time

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r top10trend,echo=FALSE,results='hide',fig.keep='all', cache= FALSE,  fig.height=4, fig.width= 6, fig.align = 'center', message=FALSE, warning = FALSE, comment=NA}

aou<-SumRelAbund(BirdData[ParkList == params$Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code # get Top 10 most abundant species (birds/point)
  
spp<-getBirdNames(BirdData[ParkList == params$Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% as_tibble() %>% rename(common = 1, AOU_Code =2)%>% 
    mutate(order= row_number())
      
plotdata<-filter(spMeanYearEffect, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
    mutate(common = fct_reorder(common, order)) %>% 
    mutate(common = paste0(common, " (", order,")")) %>% 
  left_join(.,PIFSppByBCR, by= "AOU_Code") %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"*","")) %>% 
  mutate(common2 = if_else(is.na(PIF), common, paste(PIF,"",common))) %>% 
  mutate(Nonsig = ifelse(lowCI > 0 | highCI < 0, FALSE, TRUE)) %>% 
  mutate(common2 = fct_reorder(common2, mean)) %>% 
  mutate(trend_exp= round(exp(mean),2)*100) %>%  # calc 1-exp(trend) to determine % change every 4 years
  mutate(per_change = if_else(mean > 0,trend_exp-100, 100-trend_exp)) %>%  # add directional symbol of change
  mutate(per_change = if_else(mean >0,paste0(per_change,"%"), paste0("-",per_change,"%"))) %>%  # add directional symbol of change
  mutate(per_change = if_else(Nonsig == TRUE," ",per_change))

  
BarChart<-ggplot(data= plotdata, aes(x=common2, y = mean)) +
geom_bar(fill="#2171b5", stat="identity",width=0.75) +
geom_errorbar(aes(ymin=lowCI, ymax= highCI), width = .2, color = "black")+
coord_flip()+ 
geom_text(aes(y= highCI, label = per_change),position = position_stack(), hjust=-.2)+
  expand_limits(y=c(-.5,.5))+
#scale_y_continuous(expand = c(0,0),limits = c(0, max(plotdata$mean*1.1)))+ #set origin at 0, sets width of x axis
xlab("") + labs(title = "")+
ylab(paste("Change in birds per site (log) every 4 years", "\u00B1", " 95% C.I."))+ 
theme_classic()+
theme(axis.text.y = element_text(color="black",size = 12))+
theme(axis.text.x = element_text(color="black",size = 12))+
theme(axis.title.x = element_text(color="black",size = 12, face= "bold"))+
geom_hline(yintercept= 0, col= 1)

BarChart
```

<p class='capwrap'>
Figure 8. Estimated trends in abundance between 2006 to 2019 of the top 10 most common species detected at `r params$Park` from Doser et al. (2021). The rank order of abundance in the park is denoted in parentheses following the species name. Trend estimates represent the average change in abundance on the <b> log scale</b> of a species per site every <b> four years</b>. </p>
</div>

##### <b>Top 10 Most Abundant Species at `r params$Park` </b>

<p> Figure 8 shows the trend estimates between `r params$minYear` and `r params$maxYear` for the top 10 most abundant species in `r params$Park` based on a model using time to first detection within the 10-minute point count (Doser et al. 2021). Note that trend estimates were derived from point count observations from forested and grassland/open field sites but excluded data for obligate grassland breeding species or other species primarily found in the grassland sites/open field habitats, which is why there are no trend presented for Bobolink and Tree Swallow. Average population size has not changed since `r params$minYear` for the 8 most commonly detected species we have estimates for (e.g., trend estimate error bars overlap zero) but there is an indication that detections of 5 species appear to be increasing since `r params$minYear`. American Crow and American Robin are the only common species showing non-significant increases. Refer to Figure 10 in the "Plots of Species Abundance" section to see annual counts over time for the common species and see Section "All Species Trends" to access the trends for all species by abundance ranking. </p>

<p> Of the 20 species that are of regional conservation importance at ` r params$Park` and that we have trend estimates for, the relative abundance of Field Sparrow, Golden-winged Warbler, Least Flycatcher, Northern Flicker, Rose-breasted Grosbeak, Veery, Vesper Sparrow, and Wood Thrush has remained the same since `r params$minYear`. Over this same time period we have observed significant increases in Eastern Wood-Pewee (not all species shown in Figure 8).</p>
<p>

##### <b>Trends Across NETN Parks </b>

<p>The trend in abundance of all species combined across the network has not changed since 2006 (Figure 9a) but the trend varied widely across parks (Figure 9b). For instance, the abundance of all species combined has declined in 3 parks (ACAD, MABI, and MORR) while in SARA, ROVA, and WEFA it has increased over time. Abundance of all species detected in SAGA and MIMA remained the same during this time period. </p>

<p> In parks with a significant increasing trend in overall bird abundance, like `r params$Park`, most species generally showed a similar trend to the overall park trend, but often only a fraction of the species-specific trends were significantly different from zero. For example, while the trend analysis indicated that  67 species are increasing at `r params$Park`, only detections of 4 (Eastern Wood-Pewee, Gray Catbird, Red-Bellied Woodpecker, and White-breasted Nuthatch) have increased significantly since `r params$minYear` (Figures 8 and 9c). On the other hand, only four species at `r params$Park` were found to be in decline, but not significantly (American Crow, American Robin, Black-capped Chickadee, Hermit Thrush). </p>

```{r, NETNtrends,echo=F, fig.cap= "Figure 9. Trends in bird abundance across NETN from 2006-2019 estimated by Doser et al. (2021). Panel (a) shows the linear trend (log-scale) across the entire network with the 95% credible interval in parentheses. The trend estimates represent the average change  in abundance (log-scale) per site <strong>every four years</strong>. Error in the trend estimate is denoted in parentheses. Abundance is stable when the interval does not overlap zero. Panel (b) shows the park level trends. Red highlight indicates a significant negative year trend, white highlight indicates no significant trend, and blue highlight indicates a significant positive trend. Panel (c) shows the number of species with linear trend of year estimates that are negative (red) and positive (blue) within each park. The number of species with significant trends is shown in boldface in parentheses."}
knitr::include_graphics("Fig3.jpg")
```

#### Plots of Species Abundance

Below are plots of relative abundance over time and associated trends (black line) when statistically significant (Doser et al. 2021) for the top 10 most abundant species detected since `r params$minYear` across `r params$Park`.

<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r Top10TrendPlots,echo=FALSE,results='hide',fig.keep='all', fig.height=12, fig.width= 8, fig.align = 'center', message=FALSE,warning = FALSE, comment=NA, cache=TRUE, fig.cap= "Figure 10. Relative abundance per year and associated trends over time (line) for the top 10 most abundant species detected across the park. Data exclude observations of species/individuals not suspected to be breeding in the forest (e.g., flyovers). During years when a site was surveyed more than once, the plotted average is calculated from the maximum count per survey visit among all sites in a year. The estimate of the trend (log-scale with 95% C.I.) is denoted in the upper right of each panel. If the interval does <ins>not</ins> contain zero the trend is statistically significant over time and plotted for that species (e.g., Blue Jay). Rank order of abundance is denoted in parentheses following each species name." }

#Get Top 10 species
aou<-SumRelAbund(BirdData[ParkList == params$Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code

spp<-getBirdNames(BirdData[ParkList == params$Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% as_tibble() %>% rename(common = 1, AOU_Code =2) %>% 
    mutate(order= row_number())

#subset sp_detects    
NETNplotdata<-
   left_join(spp,sp_detects, by = "AOU_Code") %>% 
    mutate(`Common Name` = common) %>% 
    mutate(common = paste0(common, " (", order,")")) %>% 
    mutate(common = fct_reorder(common, order)) %>% 
   left_join(.,spMeanYearEffect, by= c("AOU_Code","park")) %>% 
        mutate(trend_exp= round(exp(mean),2)*100) %>%  # calc 1-exp(trend) to determine % change every 4 years
    mutate(per_change = if_else(mean > 0,trend_exp-100, 100-trend_exp)) %>%  # add directional symbol of change
    mutate(per_change = if_else(mean >0,paste0(per_change,"%"), paste0("-",per_change,"%"))) %>%  # add directional symbol of change
   group_by(common)%>%  
   mutate(valueCenter = base::scale(value, center = TRUE)) %>% 
    dplyr::mutate(Nonsig= ifelse(lowCI > 0 | highCI < 0, FALSE, TRUE)) %>% 
    filter(AOU_Code %in% aou)


GraphOut<-ggplot(data=NETNplotdata, aes(x = Year, y = value, color = variable))+expand_limits(y=0)+
      geom_point(data= dplyr::filter(NETNplotdata, variable == "Field Observation"),size=2) + 
      geom_line(data= dplyr::filter(NETNplotdata, variable == "Field Observation"))+
     #geom_line(data = filter(NETNplotdata, Nonsig == FALSE & variable == "Trend Estimate")) +
      #geom_errorbar(aes(ymin= mean-se, ymax= mean +se), width = .2, color = "#2171b5")+
      theme_classic()+
      theme(axis.title.y =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.title.x =element_text(size = 14, face ="bold", vjust= 1))+
      theme(axis.text.y = element_text(color="black", vjust= 0.5,size = 12))+
      theme(axis.text.x = element_text(color="black", size = 10))+
      scale_x_continuous(breaks = seq(params$minYear, params$maxYear,2))+
      scale_color_manual(values = c("#2171b5", "black"))+
      labs(y="Number detected per point" , color = "")+
      theme(legend.position = "top")+ 
      theme(legend.text = element_text(size = 12))+
       theme(panel.background =  element_rect(fill="white", colour="black")) +
       theme(plot.title=element_text(size=12, vjust=2, face= "bold")) +
       theme(strip.background= element_rect(size=10, color="gray", linetype ="solid" ))+
      theme(strip.text=element_text(size=12, vjust=0, face= "bold"))+
      facet_wrap(~common, ncol = 2, shrink= FALSE)+
      geom_smooth(data= filter(NETNplotdata, Nonsig == FALSE & variable == "Trend Estimate"), method = "lm", se= F)
      #geom_smooth(method = "loess")
        
GraphOut+
  geom_text(data= dplyr::filter(NETNplotdata, variable == "Trend Estimate")  %>% distinct(common, park, variable, mean, lowCI, highCI, per_change) %>% drop_na(), show.legend = FALSE, aes(x = Inf, y = Inf, label=  paste(round(mean,3)," (",round(lowCI,2),",",round(highCI,2),")") , hjust = 1.05,vjust   = 1))


```
</div>

#### Regional Trends

```{r BBStable, echo= FALSE, results = 'asis', message=FALSE, warning = FALSE, cache = FALSE}

## derive fields from BBS trend data

BBS_trends<- BBS_trends %>% 
  mutate(Sig = ifelse(XCI2.5 > 0 | XCI97.5 < 0, "**", "n.s.")) %>% 
  mutate(trend_dir = ifelse(Trend > 0,"Increase", "Decrease"))
            
# arrow for decrease intToUtf8(8595)); arrow for increase intToUtf8(8593))
      
# Create trend data from NETN monitoring (rewritten from above)

aou<-SumRelAbund(BirdData[ParkList == params$Park], max=T, sort=TRUE, abund = 10, band = 1:2)$AOU_Code # get Top 20 most abundant species (birds/point)
  
spp<-getBirdNames(BirdData[ParkList == params$Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% as_tibble() %>% rename(common = 1, AOU_Code =2)%>% 
    mutate(order= row_number())
      
NETNdata<-filter(spMeanYearEffect, AOU_Code %in% aou) %>% 
   left_join(spp,., by = "AOU_Code") %>% 
  mutate(AOU_Code = fct_reorder(common, order)) %>% 
  left_join(.,PIFSppByBCR, by= "AOU_Code") %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"*","")) %>% 
  mutate(common2 = if_else(is.na(PIF), common, paste(PIF,"",common))) %>% 
  mutate(Sig = ifelse(lowCI > 0 | highCI < 0, "**", "n.s.")) %>% 
  mutate(common2 = fct_reorder(common2, mean)) %>% 
  mutate(trend_dir = ifelse(mean > 0, "Increase", "Decrease")) %>% 
  add_column(Region = paste0(params$Park, " ", params$minYear, " to ", params$maxYear)) %>% 
  dplyr::select(`Common Name`= common, order, Region, Sig, trend_dir)


## Combine BBS and NPS data

sp<- c(spp$AOU_Code) # create list of species detected by NPS to subset BBS data for

#  Use BBS Trends calculated between 2006 to 2019 using online software at https://www.mbr-pwrc.usgs.gov/bbs/trend/tf19.shtml

BBSData<-BBS_trends %>% 
  dplyr::filter(Region == params$BBSRegion | Region == params$state) %>% # subset data by BCR region of interest 
  dplyr::filter(AOU_Code %in% sp) %>%  # extract the species of interest
  dplyr::filter(Period == "2006 to 2019") %>%  # there are other periods included b/c couldn't estimate trend for all species
  mutate(Region = paste0(Region.Name," ", Period)) %>% 
  left_join(spp,., by ="AOU_Code") %>% 
  dplyr::select(`Common Name` = common, order, Region, Sig, trend_dir)
  
# using long term 1966 to 2019 published trends
# BBSData<-  mutate(BBS_trends, common = stringr::str_squish(common)) %>% # remove white space from common names for filtering
#   mutate(Region = stringr::str_squish(Region)) %>% # remove white space from region names for filtering
#   mutate(Region.Name = stringr::str_squish(Region.Name)) %>% # remove white space from region names for presentation
#   dplyr::filter(Region == params$BBSRegion | Region == params$state) %>% # subset data by BCR region of interest 
#   dplyr::filter(common %in% sp) %>%  # extract the species of interest
#     mutate(Region = paste0(Region.Name, " 1966 - 2019")) %>% 
#   dplyr::select(`Common Name` = common, Region, Sig, trend_dir)

TableData<- bind_rows(NETNdata, BBSData) %>%  
  mutate(Trend = paste0(trend_dir, " , ", Sig)) %>% dplyr::select(-Sig, -trend_dir) %>% 
  mutate(Trend = case_when(
                  Trend == "NA , NA" ~ "No Estimate",
                  Trend == "Decrease , **"  ~ cell_spec(Trend, "html", color = "red", bold = T),
                  Trend == "Decrease , n.s." ~ cell_spec(Trend, "html", color = "red", bold = F),
                  Trend ==  "Increase , **"  ~ cell_spec(Trend, "html", color = "green", bold = T),
                  Trend == "Increase , n.s." ~ cell_spec(Trend, "html", color = "green", bold = F))) %>% 
  pivot_wider(names_from = "Region", values_from= Trend) %>% 
  left_join(.,PIFSppByBCR, by= c(`Common Name` = "Common_Name")) %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"\\*","")) %>% 
  mutate(common2 = if_else(is.na(PIF), `Common Name`, paste(PIF,"",`Common Name`))) %>% 
  dplyr::select(Species= common2,3:5)
  
kableExtra::kbl(TableData, escape = FALSE, align= "l", caption = paste0("Comparison of park trends to regional trends from the USGS Breeding Bird Survey (BBS; Sauer et al. 2020) for the most commonly detected species at ", params$Park, ". An * next to a species name denotes species designated by Partners in Flight to be of conservation importance within the ", params$BCRName, " BCR (Panjabi et al. 2020). Trends: Increase or Decline denotes the average change in relative abundance over the time period. ** denotes a statistically significant Increase or Decrease in bird abundance over time whereas n.s.indicates a non-significant change in abundance over  time or a stable population."))%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) 
```

Based on the comparisons of NETN monitoring results to the BBS survey data presented above it is clear that the majority of common species detected at `r params$Park` are in decline at the state or BCR scale but most of these species are stable at the park. The main exceptions being the widely distributed American Crow and American Robin which are declining in the park and declining significantly across the state and `r params$BCRName` BCR. While NETN's trend analysis did not include Bobolink or Tree Swallow, the plots of relative abundance seen in section "Plots of Species Abundance" do appear to be more or less stable whereas at the state of BCR scale these populations are declining significantly. Overall this comparison suggests that breeding populations of common species at `r params$Park` are not following regional patterns. In contrast, Eastern Wood-Pewee, Gray Catbird, Red-Bellied Woodpecker, and White-breasted Nuthatch, which are the only species that have increased significantly at the park since `r params$minYear` also appear to be stable or increasing at the state- and BCR-scale (not shown -- BBS data available at https://www.mbr-pwrc.usgs.gov/).

#### All Species Trends 

```{r trendests, echo= FALSE, results = 'asis', message=FALSE, warning = FALSE, cache = FALSE}

aou<-SumRelAbund(BirdData[ParkList == params$Park], max=T, sort=TRUE, abund = 110, band = 1:2)$AOU_Code # get Top 10 most abundant species (birds/point)

spp<-getBirdNames(BirdData[ParkList == params$Park], names= aou , out.style = "common") %>% 
    bind_cols(.,aou ) %>% as_tibble() %>% rename(common = 1, AOU_Code =2)%>% 
    mutate(order= row_number())


spp.trend<-filter(spMeanYearEffect, park %in% params$Park) %>% 
   left_join(spp,., by = "AOU_Code")%>% 
  left_join(.,PIFSppByBCR, by= "AOU_Code") %>% # add PIF Designations
  mutate(PIF=  if_else(Regional.Importance == 1,"\\*","")) %>% 
  mutate(common2 = if_else(is.na(PIF), common, paste(PIF,"",common))) %>% 
  mutate(Nonsig = ifelse(lowCI > 0 | highCI < 0, FALSE, TRUE)) %>% 
  mutate(common2 = fct_reorder(common2, mean)) %>% 
  mutate(trend_exp= round(exp(mean),2)*100) %>%  # calc 1-exp(trend) to determine % change every 4 years
  mutate(per_change = if_else(mean > 0,trend_exp-100, 100-trend_exp)) %>%  # add directional symbol of change
  mutate(per_change = if_else(mean >0,paste0(per_change,"%"), paste0("-",per_change,"%"))) %>%  # add directional symbol of change
  mutate(per_change = if_else(Nonsig == TRUE," ",per_change)) %>% 
  mutate(mean = case_when(
                  mean >0 & Nonsig == "FALSE" ~ cell_spec(round(mean,3), "html", color = "green", bold = T),
                  mean <0 & Nonsig == "FALSE" ~ cell_spec(round(mean,3), "html", color = "red", bold = T),
                  !is.na(mean) ~ cell_spec(round(mean,3), "html",  bold = F, color="black"))) %>%
  mutate(common2 = case_when( is.na(Nonsig)~ cell_spec(common2, "html",  bold = F),
                  mean > 0 & Nonsig == "FALSE" ~ cell_spec(common2, "html",  bold = T),
                  mean < 0 & Nonsig == "FALSE" ~ cell_spec(common2, "html",  bold = T),
                  Nonsig == "TRUE" ~ cell_spec(common2, "html",  bold = F),
                  )) %>% 
  select(`Abundance Rank` = order,`Common Name` = common2, Estimate = mean, lowCI,  highCI, `Percent Change` = per_change)

options(knitr.kable.NA = '')
    
kableExtra::kbl(spp.trend, digits = 3, escape = FALSE, align= "l", longtable= T, caption = paste0("Estimated trends in abundance between 2006 to 2019 for most of the species detected at ", params$Park," from Doser et al. (2021). Trend estimates represent the average change in abundance on the <b> log scale</b> of a species per site every <b> four years </b> and are statistically significant if the interval denoted between lowCI and highCI does not include zero. Positive Trend values indicate increases over time while negative values indicate decreases. The associated average percent change in abundance every 4 years is provided for trends that are statistically significant. See Doser et al. (2021) for further details describing why some species were excluded from the analysis. An * next to a species name denotes species designated by Partners in Flight to be of conservation importance within the ", params$BCRName, " BCR (Panjabi et al. 2020).")) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% add_header_above(c("", "", "Trend" = 4))

```


### Conclusions

```{r exotics, echo=FALSE, results='hide', message=FALSE, warning = FALSE}

# did you detect exotics in park? (won't print)

exotics<-getGuilds(BirdData[ParkList == params$Park]) %>% filter(Response_Guild == "Exotic") %>% select(AOU_Code)
sp_obs<-getChecklist(BirdData[ParkList == params$Park]) %>%  as_tibble() %>% rename(AOU_Code = 1)

semi_join(exotics,sp_obs)


para<-getGuilds(BirdData[ParkList == params$Park]) %>% filter(Response_Guild == "NestPredator_BroodParasite") %>% select(AOU_Code)

semi_join(para,sp_obs) %>% distinct()
```


<div style="float:right;position:relative;top:10px;padding:5px 5px 5px 10px;margin:0px 5px 10px 5px">
```{r, forestEff,echo=F,}
knitr::include_graphics("Fig6.jpg")
```
<p class='capwrap'>
Figure 11. Relationship between average number of birds of a single species per site (y-axis) and (a) tree basal area, (b) percent forest within a 1km radius around each site, and (c) forest regeneration. Site-level basal area and regeneration were estimated from NETN's long term forest health monitoring program (Tierney et al. 2017) and % Forest from the 2011 National Land Cover Database (Homer et al. 2015). See Doser et al. (2021) for further details.</p>
</div>

```{r concl, child = "sections\\SARA_conclusions.Rmd", echo=FALSE, message=FALSE, warning = FALSE}

```

### Supporting Resources

```{r, results='asis', echo=F}
cat(readLines(paste0("Citations_",params$Park, ".html")))
```